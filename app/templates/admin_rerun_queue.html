{% extends "base.html" %}

{% block top_right %}
  <a class="btn" href="/admin/users">Users</a>
  <a class="btn" href="/admin/tasks">All Tasks</a>
  <a class="btn" href="/admin/conversations">Conversations</a>
  <a class="btn" href="/">Home</a>
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-h">Rerun Queue</div>
  <div class="card-b">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
      <a class="btn" href="/admin/rerun-queue?status=active">Active</a>
      <a class="btn" href="/admin/rerun-queue?status=queued">Queued</a>
      <a class="btn" href="/admin/rerun-queue?status=running">Running</a>
      <a class="btn" href="/admin/rerun-queue?status=done">Done</a>
      <a class="btn" href="/admin/rerun-queue?status=failed">Failed</a>
      <a class="btn" href="/admin/rerun-queue?status=canceled">Canceled</a>
      <a class="btn" href="/admin/rerun-queue?status=all">All</a>
      <span class="muted" style="margin-left:auto;">
        queued <span class="mono">{{ counts.queued }}</span> ·
        running <span class="mono">{{ counts.running }}</span> ·
        done <span class="mono">{{ counts.done }}</span> ·
        failed <span class="mono">{{ counts.failed }}</span> ·
        canceled <span class="mono">{{ counts.canceled }}</span>
      </span>
    </div>

    <div class="tablewrap">
      <table style="min-width:1200px;">
        <thead>
          <tr>
            <th>requested</th>
            <th>status</th>
            <th>user</th>
            <th>task</th>
            <th>script_key</th>
            <th>original pc</th>
            <th>locked_by</th>
            <th>exit</th>
            <th style="text-align:right;">actions</th>
          </tr>
        </thead>
        <tbody>
          {% if items|length == 0 %}
            <tr><td colspan="9" class="muted">該当データがありません</td></tr>
          {% endif %}
          {% for x in items %}
            <tr>
              <td class="muted">{{ x.requested_at_jst.strftime("%Y-%m-%d %H:%M:%S") if x.requested_at_jst else "" }}</td>
              <td><span class="chip">{{ x.status }}</span></td>
              <td>
                <div><strong>{{ x.user_name or "unknown" }}</strong></div>
                <div class="muted mono" style="font-size:12px;">{{ x.user_id }}</div>
              </td>
              <td>
                <div><strong>{{ x.task_name }}</strong></div>
                <div class="muted mono" style="font-size:12px;">{{ x.task_id }}</div>
              </td>
              <td class="mono muted">{{ x.script_key }}</td>
              <td class="mono">{{ x.original_pc_name }}</td>
              <td class="mono muted">{{ x.locked_by or "-" }}</td>
              <td class="mono">{{ x.exit_code if x.exit_code is not none else "-" }}</td>
              <td style="text-align:right;">
                {% if x.status == 'queued' %}
                  <form method="post" action="/admin/rerun-queue/{{ x.request_id }}/cancel" style="display:inline;" onsubmit="return confirm('Cancel this queued rerun?');">
                    <button class="btn" type="submit">Cancel</button>
                  </form>
                {% endif %}
                {% if x.status in ['done','failed','canceled'] %}
                  <form method="post" action="/admin/rerun-queue/{{ x.request_id }}/delete" style="display:inline;" onsubmit="return confirm('Delete this record?');">
                    <button class="btn" type="submit">Delete</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
