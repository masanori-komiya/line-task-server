{% extends "base.html" %}

{% block top_right %}
  <a class="btn" href="/admin/users">Back</a>
  <a class="btn" href="/admin/tasks">All Tasks</a>
  <a class="btn" href="/admin/task-runs">Task Runs</a>
  <a class="btn" href="/admin/conversations">Conversations</a>
  <a class="btn" href="/admin/rerun-queue">Rerun Queue</a>
  <a class="btn" href="/">Home</a>
{% endblock %}

{% block content %}

{# このページ専用の微調整CSS（base.cssを触らずに済ませる） #}
<style>
  /* 横スクロールを確実に出す */
  .tablewrap {
    overflow-x: auto;
    overflow-y: hidden;
  }

  /* テーブルは折り返し禁止。必要なら横スクロールで見る */
  table.tasks-table {
    min-width: 1600px;
    width: max-content;
    border-collapse: collapse;
    white-space: nowrap;
  }

  table.tasks-table th,
  table.tasks-table td {
    vertical-align: middle;
  }

  /* notesだけは横に伸びすぎるので省略表示（必要なら消してOK） */
  .notes-cell {
    max-width: 320px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* pc_specific列：select + Save を横並び固定 */
  .pc-specific-cell {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* createdなどの列の見やすさ */
  .mono { font-variant-ligatures: none; }
</style>

<div class="grid">
  <div class="card">
    <div class="card-h">User</div>
    <div class="card-b">
      <div style="display:flex; gap:12px; align-items:center;">
        {% if user.picture_url %}
          <img class="avatar" src="{{ user.picture_url }}" style="width:44px;height:44px;"/>
        {% else %}
          <span class="chip">?</span>
        {% endif %}
        <div>
          <div style="font-weight:800;">{{ user.user_name or "unknown" }}</div>
          <div class="muted mono" style="font-size:12px;">{{ user.user_id }}</div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">
        Last event: <span class="mono">{{ user.last_event or "" }}</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-h">Add Task</div>
    <div class="card-b">
      <form method="post" action="/admin/users/{{ user.user_id }}/tasks">
        <div class="row">
          <div>
            <label>Task name</label>
            <input name="name" required />
          </div>

          <div class="row2">
            <div>
              <label>Script name</label>
              <input name="script_key" required />
            </div>
            <div>
              <label>Time (HH:MM)</label>
              <input name="schedule_value" placeholder="hh:mm" required />
            </div>
          </div>

          <div class="row2">
            <div>
              <label>PC Name</label>
              <input name="pc_name" placeholder="default" />
            </div>
            <div>
              <label>Run Time (HH:MM:SS)</label>
              <input name="run_time" placeholder="00:00:00" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label>PC Specific</label>
              <select name="is_pc_specific" required>
                <option value="false" selected>False</option>
                <option value="true">True</option>
              </select>
            </div>
            <div>
              <label>Notify to (optional)</label>
              <select name="conversation_id">
                <option value="">(default: user)</option>
                {% for c in conversations %}
                  <option value="{{ c.conversation_id }}">[{{ c.provider }}] {{ c.display_name or c.destination }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Plan tag</label>
              <select name="plan_tag" required>
                <option value="free">free（無料枠）</option>
                <option value="paid">paid（有料枠）</option>
                <option value="expired">expired（期限切れ）</option>
              </select>
            </div>
            <div>
              <label>Expires (optional)</label>
              <input name="expires_date" type="date" />
            </div>
          </div>

          <div>
            <label>Notes</label>
            <textarea name="notes" placeholder="任意：メモ"></textarea>
          </div>

          <div>
            <label>Notes (internal)</label>
            <textarea name="note_internal" placeholder="管理者用メモ（ユーザーには表示しない）"></textarea>
          </div>

          <div class="actions">
            <button class="btn" type="submit">Create</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="card-h">Tasks</div>
  <div class="card-b tablewrap">
    <table class="tasks-table">
      <thead>
        <tr>
          <th style="min-width:150px;">task_id</th>
          <th style="min-width:150px;">created</th>
          <th style="min-width:160px;">name</th>
          <th style="min-width:200px;">script_name</th>
          <th style="min-width:90px;">time</th>
          <th style="min-width:140px;">pc_name</th>
          <th style="min-width:140px;">running_time</th>
          <th style="min-width:170px;">pc_specific</th>
          <th style="min-width:260px;">notify_to</th>
          <th style="min-width:90px;">tag</th>
          <th style="min-width:170px;">expires</th>
          <th style="min-width:90px;">enabled</th>
          <th style="min-width:260px;">notes</th>
          <th style="min-width:260px;">notes_internal</th>
          <th style="min-width:190px; text-align:right;">actions</th>
        </tr>
      </thead>

      <tbody>
        {% if tasks|length == 0 %}
          <tr>
            <td colspan="15" class="muted">まだタスクがありません</td>
          </tr>
        {% endif %}

        {% for t in tasks %}
          <tr>
            <td class="mono muted" style="font-size:12px;">{{ t.task_id }}</td>
            <td class="muted mono">
              {{ t.created_at.strftime("%Y-%m-%d %H:%M:%S") if t.created_at else "" }}
            </td>

            <td><strong>{{ t.name }}</strong></td>

            <td class="mono muted">{{ t.script_key }}</td>

            <td>
              <form id="upd-{{ t.task_id }}" method="post" action="/admin/tasks/{{ t.task_id }}/update"></form>
              <input
                name="schedule_value"
                form="upd-{{ t.task_id }}"
                value="{{ t.schedule_value }}"
                class="mono"
                style="width:80px;"
              />
            </td>

            <td>
              <input
                name="pc_name"
                form="upd-{{ t.task_id }}"
                value="{{ t.pc_name }}"
                style="width:130px;"
              />
            </td>

            <td>
              <input
                name="run_time"
                form="upd-{{ t.task_id }}"
                value="{{ t.run_time_hms or '00:00:00' }}"
                class="mono"
                style="width:120px;"
              />
            </td>

            <td>
              <div class="pc-specific-cell">
                <select name="is_pc_specific" form="upd-{{ t.task_id }}" style="width:110px;">
                  <option value="false" {% if not t.is_pc_specific %}selected{% endif %}>False</option>
                  <option value="true" {% if t.is_pc_specific %}selected{% endif %}>True</option>
                </select>
                </div>
            </td>

            <td>
              <select name="conversation_id" form="upd-{{ t.task_id }}" style="width:250px;">
                <option value="" {% if not t.conversation_id %}selected{% endif %}>(default: user)</option>
                {% for c in conversations %}
                  <option value="{{ c.conversation_id }}" {% if t.conversation_id == c.conversation_id %}selected{% endif %}>
                    [{{ c.provider }}] {{ c.display_name or c.destination }}
                  </option>
                {% endfor %}
              </select>
            </td>

            <td>
              <select name="plan_tag" form="upd-{{ t.task_id }}" style="width:86px;">
                <option value="free" {% if t.plan_tag=="free" %}selected{% endif %}>free</option>
                <option value="paid" {% if t.plan_tag=="paid" %}selected{% endif %}>paid</option>
                <option value="expired" {% if t.plan_tag=="expired" %}selected{% endif %}>expired</option>
              </select>
            </td>

            <td>
              <input
                type="date"
                name="expires_date"
                form="upd-{{ t.task_id }}"
                value="{{ t.expires_at.strftime('%Y-%m-%d') if t.expires_at else "" }}"
                style="width:150px;"
              />
            </td>

            <td>
              <select name="enabled" form="upd-{{ t.task_id }}" style="width:86px;">
                <option value="true" {% if t.enabled %}selected{% endif %}>ON</option>
                <option value="false" {% if not t.enabled %}selected{% endif %}>OFF</option>
              </select>
            </td>

            <td>
              <textarea
                name="notes"
                form="upd-{{ t.task_id }}"
                class="muted"
                style="width:250px; height:34px;"
              >{{ t.notes or "" }}</textarea>
            </td>

            <td>
              <textarea
                name="note_internal"
                form="upd-{{ t.task_id }}"
                class="muted"
                style="width:250px; height:34px;"
              >{{ t.note_internal or "" }}</textarea>
            </td>

            <td style="text-align:right;">
              <button class="btn" form="upd-{{ t.task_id }}" type="submit">Save</button>
              <form method="post" action="/admin/tasks/{{ t.task_id }}/toggle" style="display:inline;">
                <button class="btn" type="submit">{% if t.enabled %}Disable{% else %}Enable{% endif %}</button>
              </form>
              <form method="post" action="/admin/tasks/{{ t.task_id }}/delete" style="display:inline;" onsubmit="return confirm('Delete this task?');">
                <button class="btn" type="submit">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
